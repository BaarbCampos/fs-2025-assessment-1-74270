@page "/stations"
@using fs_2025_assessment_1_74270.Models
@inject fs_2025_assessment_1_74270.BlazorClient.Services.StationsApiClient ApiClient

<h1>Bike Stations</h1>

<!-- FILTROS -->
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Search (name or address)</label>
                <input class="form-control" @bind="searchText" placeholder="Type to search..." />
            </div>

            <div class="col-md-2">
                <label class="form-label">Status</label>
                <select class="form-select" @bind="statusFilter">
                    <option value="all">All</option>
                    <option value="OPEN">Open</option>
                    <option value="CLOSED">Closed</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Min bikes</label>
                <input type="number" class="form-control" @bind="minBikes" />
            </div>

            <div class="col-md-2">
                <label class="form-label">Sort by</label>
                <select class="form-select" @bind="sortField">
                    <option value="name">Name</option>
                    <option value="availableBikes">Available bikes</option>
                    <option value="occupancy">Occupancy</option>
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Sort direction</label>
                <select class="form-select" @bind="sortDir">
                    <option value="asc">Asc</option>
                    <option value="desc">Desc</option>
                </select>
            </div>
        </div>

        <div class="mt-3 d-flex gap-2">
            <button class="btn btn-primary btn-sm" @onclick="ApplyFilters" disabled="@isLoading">
                Apply filters
            </button>
            <button class="btn btn-outline-secondary btn-sm" @onclick="ResetFilters" disabled="@isLoading">
                Reset
            </button>
        </div>
    </div>
</div>

<!-- ESTADO GLOBAL -->
@if (isLoading && stations.Count == 0)
{
    <p>Loading stations...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}
else if (stations.Count == 0)
{
    <p>No stations found.</p>
}
else
{
    <!-- MASTER LIST -->
    <div class="row">
        <div class="col-lg-7">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th>Number</th>
                        <th>Name</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Bikes / Stands</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in stations)
                    {
                        <tr class="@(selectedStation?.number == s.number ? "table-active" : "")"
                            style="cursor:pointer"
                            @onclick="() => SelectStation(s)">
                            <td>@s.number</td>
                            <td>@s.name</td>
                            <td>@s.address</td>
                            <td>@s.status</td>
                            <td>@s.available_bikes / @s.bike_stands</td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="mb-3 d-flex align-items-center gap-3">
                <button class="btn btn-outline-secondary btn-sm"
                        @onclick="LoadMore"
                        disabled="@noMorePages || isLoading">
                    Load more
                </button>

                <span class="text-muted">
                    Page @currentPage
                    @if (noMorePages && currentPage > 1)
                    {
                        <text>(last page)</text>
                    }
                </span>
            </div>

            @if (isLoading && stations.Count > 0)
            {
                <p>Loading more...</p>
            }
        </div>

        <!-- DETAIL / EDIT -->
        <div class="col-lg-5">
            @if (selectedStation is null)
            {
                <div class="alert alert-info">
                    Select a station from the table to see details and edit.
                </div>
            }
            else
            {
                <div class="card mb-3">
                    <div class="card-body">
                        <h5>@selectedStation.name</h5>
                        <p class="mb-1"><strong>Address:</strong> @selectedStation.address</p>
                        <p class="mb-1">
                            <strong>Status:</strong>
                            <span class="badge @(selectedStation.status == "OPEN" ? "bg-success" : "bg-secondary")">
                                @selectedStation.status
                            </span>
                        </p>
                        <p class="mb-1">
                            <strong>Stands:</strong> @selectedStation.bike_stands<br />
                            <strong>Available bikes:</strong> @selectedStation.available_bikes<br />
                            <strong>Available stands:</strong> @selectedStation.available_bike_stands
                        </p>

                        @{
                            var occ = GetOccupancyPercent(selectedStation);
                        }
                        <p class="mt-2 mb-1"><strong>Occupancy</strong></p>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar"
                                 role="progressbar"
                                 style="@($"width: {occ:0}%;")">
                                @occ:0 % bikes in use
                            </div>
                        </div>

                        <p class="mb-1">
                            <strong>Coordinates:</strong>
                            @selectedStation.position?.lat , @selectedStation.position?.lng
                            @if (selectedStation.position != null)
                            {
                                <a target="_blank"
                                   href="https://www.google.com/maps?q=@selectedStation.position.lat,@selectedStation.position.lng">
                                    (Open in map)
                                </a>
                            }
                        </p>
                    </div>
                </div>

                <!-- EDIT FORM -->
                <div class="card mb-3">
                    <div class="card-header">Edit station</div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label class="form-label">Name</label>
                            <input class="form-control" @bind="editStation.name" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Address</label>
                            <input class="form-control" @bind="editStation.address" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" @bind="editStation.status">
                                <option value="OPEN">OPEN</option>
                                <option value="CLOSED">CLOSED</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-4 mb-2">
                                <label class="form-label">Stands</label>
                                <input type="number" class="form-control" @bind="editStation.bike_stands" />
                            </div>
                            <div class="col-4 mb-2">
                                <label class="form-label">Available bikes</label>
                                <input type="number" class="form-control" @bind="editStation.available_bikes" />
                            </div>
                            <div class="col-4 mb-2">
                                <label class="form-label">Available stands</label>
                                <input type="number" class="form-control" @bind="editStation.available_bike_stands" />
                            </div>
                        </div>

                        <div class="mt-2 d-flex gap-2">
                            <button class="btn btn-primary btn-sm" @onclick="SaveEdit" disabled="@isSaving">
                                Save
                            </button>
                            <button class="btn btn-danger btn-sm" @onclick="DeleteSelected" disabled="@isSaving">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            }

            <!-- CREATE NEW -->
            <div class="card">
                <div class="card-header">Add new station</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-4 mb-2">
                            <label class="form-label">Number</label>
                            <input type="number" class="form-control" @bind="newStation.number" />
                        </div>
                        <div class="col-8 mb-2">
                            <label class="form-label">Name</label>
                            <input class="form-control" @bind="newStation.name" />
                        </div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label">Address</label>
                        <input class="form-control" @bind="newStation.address" />
                    </div>

                    <div class="row">
                        <div class="col-4 mb-2">
                            <label class="form-label">Stands</label>
                            <input type="number" class="form-control" @bind="newStation.bike_stands" />
                        </div>
                        <div class="col-4 mb-2">
                            <label class="form-label">Available bikes</label>
                            <input type="number" class="form-control" @bind="newStation.available_bikes" />
                        </div>
                        <div class="col-4 mb-2">
                            <label class="form-label">Available stands</label>
                            <input type="number" class="form-control" @bind="newStation.available_bike_stands" />
                        </div>
                    </div>

                    <div class="mt-2">
                        <button class="btn btn-success btn-sm" @onclick="CreateNew" disabled="@isSaving">
                            Create
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // lista principal
    private List<BikeStation> stations = new();

    // estado
    private bool isLoading = false;
    private bool isSaving = false;
    private string? errorMessage;

    // filtros
    private string? searchText;
    private string statusFilter = "all";
    private int? minBikes;
    private string sortField = "name";
    private string sortDir = "asc";

    // paginação
    private int currentPage = 1;
    private int pageSize = 20;
    private bool noMorePages = false;

    // detail / edit / create
    private BikeStation? selectedStation;
    private BikeStation editStation = new();
    private BikeStation newStation = new();

    protected override async Task OnInitializedAsync()
    {
        await ReloadFromFirstPage();
    }

    private async Task ReloadFromFirstPage()
    {
        stations.Clear();
        currentPage = 1;
        noMorePages = false;
        await LoadPage();
    }

    private async Task LoadPage()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var q = string.IsNullOrWhiteSpace(searchText) ? null : searchText;
            string? status = statusFilter == "all" ? null : statusFilter;

            var result = await ApiClient.GetStationsAsync(
                q: q,
                status: status,
                minBikes: minBikes,
                sort: sortField,
                dir: sortDir,
                page: currentPage,
                pageSize: pageSize);

            if (result != null)
            {
                stations.AddRange(result);

                if (result.Count < pageSize)
                {
                    noMorePages = true;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Could not load stations from the API. Details: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private Task ApplyFilters()
    {
        return ReloadFromFirstPage();
    }

    private Task ResetFilters()
    {
        searchText = null;
        statusFilter = "all";
        minBikes = null;
        sortField = "name";
        sortDir = "asc";
        return ReloadFromFirstPage();
    }

    private async Task LoadMore()
    {
        if (noMorePages || isLoading) return;

        currentPage++;
        await LoadPage();
    }

    private async Task SelectStation(BikeStation station)
    {
        try
        {
            // pega a versão mais atual do API
            selectedStation = await ApiClient.GetStationAsync(station.number) ?? station;

            // faz cópia para o formulário de edição
            editStation = new BikeStation
            {
                number = selectedStation.number,
                name = selectedStation.name,
                address = selectedStation.address,
                status = selectedStation.status,
                bike_stands = selectedStation.bike_stands,
                available_bikes = selectedStation.available_bikes,
                available_bike_stands = selectedStation.available_bike_stands,
                position = selectedStation.position,
                last_update = selectedStation.last_update
            };
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading station details: {ex.Message}";
        }
    }

    private async Task SaveEdit()
    {
        if (selectedStation is null) return;

        try
        {
            isSaving = true;
            await ApiClient.UpdateStationAsync(editStation.number, editStation);

            // atualiza na lista
            var idx = stations.FindIndex(s => s.number == editStation.number);
            if (idx >= 0)
            {
                stations[idx] = editStation;
            }

            selectedStation = editStation;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving station: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteSelected()
    {
        if (selectedStation is null) return;

        try
        {
            isSaving = true;
            await ApiClient.DeleteStationAsync(selectedStation.number);

            stations.RemoveAll(s => s.number == selectedStation.number);
            selectedStation = null;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting station: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task CreateNew()
    {
        try
        {
            isSaving = true;
            var created = await ApiClient.CreateStationAsync(newStation);

            if (created != null)
            {
                stations.Insert(0, created);
                newStation = new BikeStation();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating station: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private double GetOccupancyPercent(BikeStation s)
    {
        if (s.bike_stands <= 0) return 0;
        return (double)s.available_bikes / s.bike_stands * 100.0;
    }
}
